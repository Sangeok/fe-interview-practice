## 테스트 개선 로드맵(기획) — 유닛/통합 테스트 고도화 계획

본 문서는 현재 테스트 현황과 커버리지 리포트를 기반으로 실천 가능한 개선 계획을 정리한 것입니다. 전략적 방향성(원칙, 분류, 기준)은 `docs/TEST_STRATEGY.md`를 준수하며, 여기서는 “무엇을 언제 어떻게” 고도화할지에 집중합니다.

### 1) 목표와 비전
- **목표**: 핵심 영역 회귀 방지와 빠른 피드백을 보장하는 실용적 테스트 체계 확립
- **정량 지표(초기 게이트)**: Lines ≥ 80%, Statements ≥ 80%, Branches ≥ 70%, Functions ≥ 75%
- **정량 지표(상향 목표)**: Lines ≥ 85%, Branches ≥ 80% (우선순위 영역 달성 후 점진 상향)
- **범위**: 유닛, 통합(컴포넌트·훅·API Route 중심). E2E는 후속 문서에서 별도 정의

### 2) 현재 상태 요약(스냅샷)
- 러너/환경: Vitest, jsdom, setup 파일 구성 양호
- 커버리지(최근 리포트): Statements 78.89%, Lines 79.33% 등 전반 양호
- 강점: 라이브러리/스토어/주요 UI/Next API Route의 성공·에러·파싱 실패 등 분기 테스트 보유
- 보완 필요 영역(낮은/미커버):
  - `fsd/features/chat/chatMessage/ui/_component/BotMessage/model/hooks` — 훅 커버리지 낮음(약 28%)
  - `fsd/features/chat/chatMessage/ui/_component/BotMessage/ui/_component/*` — 일부 0%
  - `fsd/widgets/interviewOption/ui/multipleChoiceInterview/model/hooks` — 약 34%
  - `fsd/features/chat/chatInput/ui` — 분기 커버리지 상대적 낮음(약 54%)

### 3) 리스크와 원인 가설
- 타이머/비동기/언마운트 연관 훅은 타이밍/정리(cleanup) 시나리오 누락 시 커버리지 하락
- 피드백/딥다이브 UI는 데이터 결손/경계값 시나리오 테스트 부족
- 객관식 인터뷰 훅은 상태 전이·분기(활성/비활성/정답 판정) 테스트 미흡
- 입력/전송 UI(예: ChatInput)는 입력 검증, 로딩 상태, 단축키 등 분기 미커버

### 4) 단계별 실행 계획(Phase → Step)

#### Phase 0 — 공통 가드레일 정비(빠른 승수 효과)
- Step 0-1: 커버리지 임계치 도입(프로젝트 단위)
  - 목표: Lines ≥ 80, Statements ≥ 80, Branches ≥ 70, Functions ≥ 75
  - 실패 시 CI 실패로 회귀 방지(브랜치 보호 규칙과 연계)
- Step 0-2: 테스트 네이밍/구조 컨벤션 확정(GWT, AAA 등)
- Step 0-3: 공통 테스트 유틸 추가(타이머/시간 고정, 공용 픽스처 팩토리)

#### Phase 1 — 훅/피드백 UI의 미커버 영역 해소(가치/난이도 대비 효율 높음)
- 대상 A: `BotMessage` 계열 훅(예: `useTypewriter`)
  - Step 1-A-1: `vi.useFakeTimers()` 기반 초기 상태/증분 로직 검증
  - Step 1-A-2: 언마운트 시 타이머 정리(cleanup) 검증
  - Step 1-A-3: 경계값(빈 문자열, 매우 긴 문자열, 속도 파라미터 경계) 검증
  - Step 1-A-4: 의존 prop 변경 시 재시작/중단 동작 검증
- 대상 B: 피드백 UI(0%에 가까운 하위 컴포넌트)
  - Step 1-B-1: 정상 데이터 렌더링(헤더/리스트/딥다이브 섹션)
  - Step 1-B-2: 결손 데이터(빈 배열/null/optional field 누락) Fallback 렌더링
  - Step 1-B-3: 긴 텍스트/스크롤/접힘-펼침(있다면) 상호작용
  - Step 1-B-4: 접근성 속성(role/aria) 최소 검증

#### Phase 2 — 객관식 인터뷰 훅과 입력 UI의 분기 보강
- 대상 C: `multipleChoiceInterview` 모델 훅
  - Step 2-C-1: 초기 상태/질문 로드/선택 불가 조건(없다면 스킵)
  - Step 2-C-2: 옵션 선택 → 정답 판정/점수/다중선택 규칙 분기
  - Step 2-C-3: 다음 문항 이동 가능/불가 분기, 재시도/리셋 로직
  - Step 2-C-4: 비정상 입력/빈 데이터 방어 로직
- 대상 D: `ChatInput` UI
  - Step 2-D-1: 빈 입력 차단, 엔터키/버튼 전송 분기
  - Step 2-D-2: 로딩 중 비활성화, 중복 전송 방지
  - Step 2-D-3: 에러 상태 메시지/복구 경로

#### Phase 3 — API Route 부정/한계 케이스 추가 및 커버리지 상향
- 대상 E: Next.js API Route(`generate-feedback`, `generate-interpret`)
  - Step 3-E-1: 타임아웃/서드파티 오류 메시지 전파 경로
  - Step 3-E-2: 페이로드 초과/필드 타입 불일치/필수 필드 다중 누락
  - Step 3-E-3: 모델 응답 스키마 변형(옵셔널 필드 유무)에 대한 방어 코드 검증
- 목표 상향: Lines/Statements 85%+, Branches 80% 달성

### 5) 상세 가이드(유형별)

#### A. 훅 테스트 가이드
- 타이머/인터벌: `vi.useFakeTimers()` + `vi.advanceTimersByTime()`로 결정론적 검증
- 언마운트: `renderHook`의 `unmount()` 후 내부 클린업 부작동 여부 확인
- 의존성 변경: `rerender(props)`로 재시작/중단/누적 여부 확인

#### B. 컴포넌트 테스트 가이드
- 데이터 상태(정상/결손/경계) 3종 세트로 구성
- 상호작용: 클릭/키보드 이벤트, 로딩/에러 전이
- 접근성: 최소한의 role/label 검증(중요 뷰만)

#### C. 모델/로직 테스트 가이드
- 상태 전이 다이어그램 기반으로 분기 목록화 → 테스트 케이스로 치환
- 불변성(원본 배열/객체 미변경)과 결정론적 결과 검증
- 방어 로직: 빈/잘못된 입력 시 안전 반환

#### D. API Route 테스트 가이드
- 성공/실패/JSON 파싱 오류(이미 보유) + 한계 케이스(타임아웃/스키마 변형)
- 외부 호출: `vi.mock`으로 격리, 에러 메시지/스택 포함 여부 검증

### 6) 데이터/픽스처 전략
- 최소 픽스처: 단일 파일에 공용 타입 안전 팩토리(예: `makeFeedbackData`, `makeDeepDiveData`)
- 빌더 패턴: 옵션으로 필드 결손/경계값을 손쉽게 생성
- 랜덤 제거: 결정론 유지(필요 시 `Math.random` 스파이/모킹)

### 7) 커버리지 정책과 게이팅
- 프로젝트 전역 임계치(Phase 0) 적용 후, 디렉토리별 임계치 상향은 단계별 PR에서 추진
- 리포트 아티팩트(HTML/LCOV) CI 업로드(추적/리뷰 용이성)

### 8) CI 연동(개략)
- `npm run test:coverage` 수행 → 임계치 미달 시 실패
- PR 체크: 테스트 + 린트 병행, 커버리지 배지/링크(선택)

### 9) 품질 바 기준(DoD)
- 신규/변경 코드: 관련 테스트 존재
- 리그레션 방지: 버그 수정 시 최소 1개의 재현 테스트 추가
- 커버리지 임계치 충족 + 리뷰어가 시나리오 충분성 확인

### 10) 단계별 체크리스트(실행용)

#### Phase 0
- [ ] 커버리지 임계치 설정(프로젝트 전역)
- [ ] 공통 테스트 유틸/픽스처 팩토리 추가
- [ ] 테스트 네이밍/구조 컨벤션 문서화

#### Phase 1 — 훅/피드백 UI
- [ ] `useTypewriter` 초기/증분/종료/경계값/리렌더 케이스 추가
- [ ] DeepDive/Feedback UI 정상/결손/경계/접근성 케이스 추가
- [ ] 커버리지 확인: 해당 디렉토리 Lines ≥ 80%, Branches ≥ 70%

#### Phase 2 — 객관식 훅/입력 UI
- [ ] 객관식 훅: 상태 전이/정답 판정/이동/리셋/방어 로직 케이스 추가
- [ ] ChatInput: 빈입력/엔터/버튼/로딩/중복 전송/에러 케이스 추가
- [ ] 커버리지 확인: 대상 디렉토리 Branches ≥ 75% 달성

#### Phase 3 — API Route 강화
- [ ] 타임아웃/한계/스키마 변형 에러 케이스 추가
- [ ] 상향 목표(프로젝트 전역) Lines ≥ 85%, Branches ≥ 80% 달성

### 11) 참고 링크
- 전략 문서: `docs/TEST_STRATEGY.md`
- 커버리지 리포트: `coverage/index.html`

---
본 문서는 실행 중심으로 유지되며, 각 Phase 완료 후 실제 수치/경험을 반영해 임계치 및 우선순위를 재조정합니다.


